name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=fmt result=success" > gate-artifacts/fmt.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-fmt
          path: gate-artifacts/fmt.txt

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Guard Windows path hygiene in tests
        run: ./scripts/check_test_path_hygiene.sh
      - name: Install Windows cross-compiler for runtime warning gate
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mingw-w64-x86-64
      - name: Guard trust-runtime cross-target warnings
        run: ./scripts/check_runtime_cross_target_warnings.sh --install-missing --require-cross
      - run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=clippy result=success" > gate-artifacts/clippy.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-clippy
          path: gate-artifacts/clippy.txt

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Prepare test log path
        shell: bash
        run: |
          mkdir -p gate-artifacts
          : > "gate-artifacts/test-${{ matrix.os }}.log"
      - name: Free disk space on ubuntu runners
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android || true
          df -h
      - name: Run cargo build --all-targets (retry once on transient failure)
        shell: bash
        run: |
          set -euo pipefail
          LOG_PATH="gate-artifacts/test-${{ matrix.os }}.log"
          for attempt in 1 2; do
            echo "=== cargo build attempt ${attempt}/2 (${{ matrix.os }}) ===" | tee -a "${LOG_PATH}"
            if cargo build --all-targets 2>&1 | tee -a "${LOG_PATH}"; then
              exit 0
            fi
            if [[ "${attempt}" -lt 2 ]]; then
              echo "cargo build failed on attempt ${attempt}; retrying once..." | tee -a "${LOG_PATH}"
            fi
          done
          echo "cargo build --all-targets failed after 2 attempts." | tee -a "${LOG_PATH}"
          exit 1
      - name: trust-runtime warnings denied
        shell: bash
        run: RUSTFLAGS=-Dwarnings cargo check -p trust-runtime --all-targets
      - name: Mesh TLS stability gate
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            echo "Skipping mesh TLS stress gate on windows-latest; covered by linux/macos runs."
            exit 0
          fi
          ./scripts/runtime_mesh_tls_stability_gate.sh --iterations 4
      - run: cargo test -p trust-runtime --test complete_program
      - name: Run full test suite
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p gate-artifacts
          LOG_PATH="gate-artifacts/test-${{ matrix.os }}.log"
          : > "${LOG_PATH}"
          run_full_suite() {
            if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
              cargo test --all-targets -- --test-threads=1
            else
              cargo test --all-targets
            fi
          }
          for attempt in 1 2; do
            echo "=== full test suite attempt ${attempt}/2 (${{ matrix.os }}) ===" | tee -a "${LOG_PATH}"
            if run_full_suite 2>&1 | tee -a "${LOG_PATH}"; then
              exit 0
            fi
            if [[ "${attempt}" -lt 2 ]]; then
              echo "Attempt ${attempt} failed; retrying once..." | tee -a "${LOG_PATH}"
            fi
          done
          echo "Full test suite failed after 2 attempts." | tee -a "${LOG_PATH}"
          exit 1
      - name: Upload test suite log
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-log-${{ matrix.os }}
          path: gate-artifacts/test-${{ matrix.os }}.log
      - name: Mark gate success
        if: ${{ success() }}
        shell: bash
        run: |
          mkdir -p gate-artifacts
          echo "job=test os=${{ matrix.os }} result=success" > gate-artifacts/test-${{ matrix.os }}.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-test-${{ matrix.os }}
          path: gate-artifacts/test-${{ matrix.os }}.txt

  conformance:
    name: Conformance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run conformance suite (pass 1)
        run: |
          mkdir -p gate-artifacts
          cargo run -p trust-runtime --bin trust-runtime -- \
            conformance \
            --suite-root conformance \
            --output gate-artifacts/conformance-pass-1.json
      - name: Run conformance suite (pass 2)
        run: |
          cargo run -p trust-runtime --bin trust-runtime -- \
            conformance \
            --suite-root conformance \
            --output gate-artifacts/conformance-pass-2.json
      - name: Verify deterministic ordering and statuses
        run: |
          jq 'del(.generated_at_utc) | .results |= map(del(.duration_ms))' \
            gate-artifacts/conformance-pass-1.json > gate-artifacts/conformance-pass-1.normalized.json
          jq 'del(.generated_at_utc) | .results |= map(del(.duration_ms))' \
            gate-artifacts/conformance-pass-2.json > gate-artifacts/conformance-pass-2.normalized.json
          diff -u \
            gate-artifacts/conformance-pass-1.normalized.json \
            gate-artifacts/conformance-pass-2.normalized.json
      - name: Upload conformance artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: conformance-suite
          path: gate-artifacts/conformance-pass-*.json
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=conformance result=success" > gate-artifacts/conformance.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-conformance
          path: gate-artifacts/conformance.txt

  msrv:
    name: MSRV (1.85)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.85
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --all-targets
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=msrv result=success" > gate-artifacts/msrv.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-msrv
          path: gate-artifacts/msrv.txt

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=docs result=success" > gate-artifacts/docs.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-docs
          path: gate-artifacts/docs.txt

  browser-analysis:
    name: Browser Analysis Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install wasm target
        run: rustup target add wasm32-unknown-unknown
      - name: Run parity + latency + memory + incremental gates
        run: ./scripts/check_mp010_browser_analysis.sh
      - name: Run browser host smoke gate
        run: ./scripts/check_browser_analysis_host_smoke.sh
      - name: Run worker recovery gate
        run: ./scripts/check_browser_analysis_worker_recovery.sh
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=browser-analysis result=success" > gate-artifacts/browser-analysis.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-browser-analysis
          path: gate-artifacts/browser-analysis.txt

  vscode-extension:
    name: VS Code Extension
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: editors/vscode
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: editors/vscode/package-lock.json
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: npm ci
      - run: npm run lint
      - run: npm run compile
      - name: Build trust-lsp test server
        run: cargo build -p trust-lsp
        working-directory: ${{ github.workspace }}
      - name: Add trust-lsp binary directory to PATH
        run: echo "${{ github.workspace }}/target/debug" >> "$GITHUB_PATH"
      - name: Install virtual display dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      - name: Run extension integration tests
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/gate-artifacts"
          LOG_PATH="${GITHUB_WORKSPACE}/gate-artifacts/vscode-extension-test.log"
          : > "${LOG_PATH}"
          for attempt in 1 2; do
            echo "=== VS Code integration attempt ${attempt}/2 ===" | tee -a "${LOG_PATH}"
            if xvfb-run -a npm test 2>&1 | tee -a "${LOG_PATH}"; then
              exit 0
            fi
            if [[ "${attempt}" -lt 2 ]]; then
              echo "Attempt ${attempt} failed; retrying once..." | tee -a "${LOG_PATH}"
            fi
          done
          echo "VS Code integration tests failed after 2 attempts." | tee -a "${LOG_PATH}"
          exit 1
        env:
          ST_LSP_TEST_SERVER: ${{ github.workspace }}/target/debug/trust-lsp
      - name: Upload VS Code integration test log
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: vscode-extension-test-log
          path: gate-artifacts/vscode-extension-test.log
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p "${GITHUB_WORKSPACE}/gate-artifacts"
          echo "job=vscode-extension result=success" > "${GITHUB_WORKSPACE}/gate-artifacts/vscode-extension.txt"
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-vscode-extension
          path: gate-artifacts/vscode-extension.txt

  editor-expansion:
    name: Editor Expansion Smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Validate Neovim/Zed editor setup and core workflow coverage
        run: ./scripts/check_editor_integration_smoke.sh
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=editor-expansion result=success" > gate-artifacts/editor-expansion.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-editor-expansion
          path: gate-artifacts/editor-expansion.txt

  mp001-parity:
    name: MP-001 Parity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify split-test parity and discovery stability
        run: scripts/check_mp001_split_parity.sh --verify
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=mp001-parity result=success" > gate-artifacts/mp001-parity.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-mp001-parity
          path: gate-artifacts/mp001-parity.txt

  version-release-guard:
    name: Version Release Guard
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate workspace/extension version alignment
        run: |
          python3 scripts/check_release_version_alignment.py
      - name: Validate version bump release evidence
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/check_version_release_evidence.py \
            --event-name "${{ github.event_name }}" \
            --ref "${{ github.ref }}" \
            --before "${{ github.event.before }}" \
            --after "${{ github.sha }}" \
            --repo "${{ github.repository }}"
      - name: Mark gate success
        if: ${{ success() }}
        run: |
          mkdir -p gate-artifacts
          echo "job=version-release-guard result=success" > gate-artifacts/version-release-guard.txt
      - name: Upload gate marker
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: gate-version-release-guard
          path: gate-artifacts/version-release-guard.txt

  release-gate-report:
    name: Release Gate Report
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, msrv, docs, browser-analysis, vscode-extension, editor-expansion, mp001-parity, version-release-guard]
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@v4

      - name: Prepare gate artifact directory
        run: mkdir -p gate-artifacts

      - name: Download gate markers
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          path: gate-artifacts
          pattern: gate-*

      - name: Generate release gate report
        env:
          NEED_FMT: ${{ needs.fmt.result }}
          NEED_CLIPPY: ${{ needs.clippy.result }}
          NEED_TEST: ${{ needs.test.result }}
          NEED_MSRV: ${{ needs.msrv.result }}
          NEED_DOCS: ${{ needs.docs.result }}
          NEED_BROWSER_ANALYSIS: ${{ needs['browser-analysis'].result }}
          NEED_VSCODE_EXTENSION: ${{ needs['vscode-extension'].result }}
          NEED_EDITOR_EXPANSION: ${{ needs['editor-expansion'].result }}
          NEED_MP001_PARITY: ${{ needs['mp001-parity'].result }}
          NEED_VERSION_RELEASE_GUARD: ${{ needs['version-release-guard'].result }}
        run: |
          python3 scripts/generate_release_gate_report.py \
            --output-dir gate-report \
            --gate-artifacts-dir gate-artifacts \
            --required-gate gate-fmt \
            --required-gate gate-clippy \
            --required-gate gate-test-ubuntu-latest \
            --required-gate gate-test-macos-latest \
            --required-gate gate-test-windows-latest \
            --required-gate gate-msrv \
            --required-gate gate-docs \
            --required-gate gate-browser-analysis \
            --required-gate gate-vscode-extension \
            --required-gate gate-editor-expansion \
            --required-gate gate-mp001-parity \
            --required-gate gate-version-release-guard \
            --job-status "fmt=${NEED_FMT}" \
            --job-status "clippy=${NEED_CLIPPY}" \
            --job-status "test=${NEED_TEST}" \
            --job-status "msrv=${NEED_MSRV}" \
            --job-status "docs=${NEED_DOCS}" \
            --job-status "browser-analysis=${NEED_BROWSER_ANALYSIS}" \
            --job-status "vscode-extension=${NEED_VSCODE_EXTENSION}" \
            --job-status "editor-expansion=${NEED_EDITOR_EXPANSION}" \
            --job-status "mp001-parity=${NEED_MP001_PARITY}" \
            --job-status "version-release-guard=${NEED_VERSION_RELEASE_GUARD}" \
            --checklist docs/release-gate-checklist.md

      - name: Upload release gate report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: release-gate-report
          path: gate-report/
